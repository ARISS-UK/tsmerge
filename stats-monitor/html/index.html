<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<link rel="icon" href="/favicon.ico">
<title>tsmerge monitor</title>
<style>
body {
    font-family: "Open Sans", Arial, sans-serif;
}
.rx_station-stat-label {
    font-size: 1.1em;
}
.rx_station-stat {
    display: block-inline;
    margin-left: 12px;
    width: 35px;
    font-size: 1.1em;
    font-weight: bold;
}
.rx_graph-legend {
  display:inline-block;
  font-size: 1.3em;
}
.font-red {
  color: rgba(255, 0, 0, 1);
}
.font-green {
  color: rgba(0, 255, 0, 1);
}
.font-blue {
  color: rgba(0, 0, 255, 1);
}
.font-yellow {
  color: rgba(255, 255, 0, 1);
}
#column-contrib-graph {
  display: inline-block;
}
.poster-icon.play {
    display: none !important;
}
.spinner-three-bounce {
    display: none !important;
}
#stream-player-overlay {
    color: white;
    /*background-color: rgba(0, 0, 0, 0.5);*/

  background: rgba(0,0,0,0.5);
  background: -webkit-linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5),rgba(0,0,0,0));
  background: -o-linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5),rgba(0,0,0,0));
  background: -moz-linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5),rgba(0,0,0,0));
  background: linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5),rgba(0,0,0,0));

    text-align: center;
    padding-top: 35px;
    padding-bottom: 25px;
    height: auto;
    width: inherit;
    font-size: 3em;
    font-weight: bold;
    position: absolute;
    z-index: 100;
    opacity: 1 !important;
}
.panel-body > .station-tag {
  opacity: 0.1;
  display: block;
  margin-bottom: 7px;
}
</style>
<link rel="stylesheet" href="libs/bootstrap-3.3.7/css/bootstrap.min.css">
</head>
<body>
<div id="page-container" class="container">
<div class="page-header">
  <a href="https://github.com/fsphil/tsmerge" target="_blank" class="pull-right">Project by Phil Heron</a>
  <h1>HAMTV TS Merger Monitor</h1>
</div>
<div id="player-row" class="row">
  <div id="column-contrib-graph">
    <h3>Output Contribution</h3>
    <br />
    <canvas id="output_stations_graph" width="400" height="100"></canvas>
    <div class="rx_graph-legend">
      <span class="glyphicon glyphicon-minus font-red"></span><span id="graph-legend-0"></span><br>
      <span class="glyphicon glyphicon-minus font-green"></span><span id="graph-legend-1"></span><br>
      <span class="glyphicon glyphicon-minus font-blue"></span><span id="graph-legend-2"></span><br>
      <span class="glyphicon glyphicon-minus font-yellow"></span><span id="graph-legend-3"></span><br>
    </div>
    <br><br>
    Direct TS Feed: <a href="tcp://hamtv.batc.tv:5679">tcp://hamtv.batc.tv:5679</a>
  </div>
  <div id="stream-player" class="pull-right">
    <div id="stream-player-overlay">Standing by for HAMTV</div>
  </div>
</div>
<h2>Receiver Stations</h2>
<div id="rx_stations_row" class="row"></div>

<h2>Server Status</h2>
tsmerge: <span id="tsmerge_server"></span><br />
RX Buffer Queue: <span id="rx_buffer_queue"></span> packets<br />
RX Buffer Loss : <span id="rx_buffer_loss"></span> packets<br />
<h4>Threads</h4>
<div id="server_threads"></div>

</div>
</body>
<script src="libs/jquery-3.1.1.min.js"></script>
<script src="socket.io/socket.io.js"></script>
<script src="libs/bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script src="libs/smoothie.js"></script>
<script src="libs/clappr/clappr.min.js"></script>
<script src="libs/clappr/rtmp/rtmp.min.js"></script>
<script src="libs/batc.js"></script>
<script>
var rtmpUrl = "rtmp://beta.batc.tv:1935/event/goonhilly";

var station_contrib_graphOptions = [
  { strokeStyle: 'rgba(255, 0, 0, 1)', fillStyle: 'rgba(255, 0, 0, 0.3)', lineWidth: 3 },
  { strokeStyle: 'rgba(0, 255, 0, 1)', fillStyle: 'rgba(0, 255, 0, 0.3)', lineWidth: 3 },
  { strokeStyle: 'rgba(0, 0, 255, 1)', fillStyle: 'rgba(0, 0, 255, 0.3)', lineWidth: 3 },
  { strokeStyle: 'rgba(255, 255, 0, 1)', fillStyle: 'rgba(255, 255, 0, 0.3)', lineWidth: 3 },
  { strokeStyle: 'rgba(255, 0, 255, 1)', fillStyle: 'rgba(255, 0, 255, 0.3)', lineWidth: 3 },
];

var last_server_data = 0;
var mx_merger = null;
var rx_stations = [null, null, null, null];
var rx_stations_timegraph = new SmoothieChart({
  millisPerPixel: 50,
  grid: {
    strokeStyle: '#555555',
    lineWidth: 1,
    millisPerLine: 1000,
    verticalSections: 4
    }
  }
);
mx_merger = {
  "data_received": 0,
  "gui_updated": 0,
  "output_live": 0
};
rx_stations.forEach(function(station, station_index)
{
  rx_stations[station_index] = {
    /* Cached Panel Selector */
    "panel": null,
    
    /* Callsign of station */
    "callsign": "[Station Slot Free]",
    
    "received": 0,
    "received_sum": 0,
    
    "selected": 0,
    "selected_percent": 0,
    "selected_sum": 0,
    
    "lost_sum": 0,
    
    /* Contribution graph data */
    "graph_data": new TimeSeries(),
    "graph_options": station_contrib_graphOptions[station_index],
  };
  
  /* Set up contribution graph data */
  rx_stations[station_index].graph_data.append(new Date().getTime(), 0);
  rx_stations_timegraph.addTimeSeries(
    rx_stations[station_index].graph_data,
    rx_stations[station_index].graph_options
  );
});
rx_stations_timegraph.streamTo(document.getElementById('output_stations_graph'), 100);

var status_output = false;
var status_counter = 0;
var player_overlay = true;
function checkStatus()
{
  if(mx_merger.output_live && !status_output)
  {
    status_counter++;
    if(status_counter > 10)
    {
      status_output = true;
      status_counter = 0;
    }
  }

  if(!mx_merger.output_live && status_output)
  {
    status_counter--;
    if(status_counter < -20)
    {
      status_output = false;
      status_counter = 0;
    }
  }

  if(!status_output && !player_overlay)
  {
    $("#stream-player-overlay").show();
    player_overlay = true;
  }
  else if(status_output && player_overlay)
  {
    $("#stream-player-overlay").hide();
    player_overlay = false;
  }
  
  setTimeout(checkStatus,50);
}
checkStatus();

function create_stations()
{
  var colwidth = Math.floor(12/rx_stations.length);
  rx_stations.forEach(function(station, station_id)
  {
    var col = $('<div></div>')
      .attr('id', 'column-rx_station-'+station_id)
      .attr('class', 'col-md-'+colwidth);
        
    station.panel = $('<div></div>')
      .attr('id', 'panel-rx_station-'+station_id)
      .attr('class', 'panel panel-default');
    
    var panel_heading = $('<div></div>')
      .attr('class', 'panel-heading');
    
    panel_heading.append($('<h3></h3>')
                            .attr('id','title-rx_station-'+station_id)
                            .attr('class', 'panel-title')
                         );
    
    station.panel.append(panel_heading);
    
    var panel_body = $('<div></div>')
                        .attr('class', 'panel-body');
    
    panel_body.append($('<span></span>')
                        .attr('id','rx_station-selecting-label-'+station_id)
                        .attr('class','label label-success station-tag')
                        .text('Station selected as prime receiver'));

    panel_body.append($('<span></span>')
                        .attr('id','rx_station-streaming-label-'+station_id)
                        .attr('class','label label-info station-tag')
                        .text('Station is receiving'));

    panel_body.append($('<span></span>')
                        .attr('id','rx_station-netloss-label-'+station_id)
                        .attr('class','label label-warning station-tag')
                        .text('Upload Network Loss Detected'));

    /* Graphic here? */
                        
    panel_body.append($('<hr />'));
    
    panel_body.append($('<span></span>')
                        .attr('class', 'rx_station-stat-label')
                        .text('Last Data: '));
    panel_body.append($('<span></span>')
                        .attr('id','rx_station-active-'+station_id)
                        .attr('class', 'rx_station-stat'))
                        .append($('<br />'));
    
    panel_body.append($('<span></span>')
                        .attr('class', 'rx_station-stat-label')
                        .text('Total TS Packets: '));
    panel_body.append($('<span></span>')
                        .attr('id','rx_station-total-'+station_id)
                        .attr('class', 'rx_station-stat'))
                        .append($('<br />'));
    
    panel_body.append($('<span></span>')
                        .attr('class', 'rx_station-stat-label')
                        .text('Network Loss: '));
    panel_body.append($('<span></span>')
                        .attr('id','rx_station-netloss-'+station_id)
                        .attr('class', 'rx_station-stat'))
                        .append($('<br />'));
    
    panel_body.append($('<span></span>')
                        .attr('class', 'rx_station-stat-label')
                        .text('Selected: '));
    panel_body.append($('<span></span>')
                        .attr('id','rx_station-selected-'+station_id)
                        .attr('class', 'rx_station-stat')
                        .append($('<br />')));
    
    station.panel.append(panel_body);
    col.append(station.panel);
    $("#rx_stations_row").append(col);
  });
}

function render_stations()
{
  var graphTime = new Date().getTime();

  rx_stations.forEach(function(station, station_id)
  {
    /* Set panel colour based on station status */
    if(station.received != 0)
    {
      if(station.selected != 0)
      {
        /* Station is streaming and selected for output */
        /* Green panel - set if not already set */
        if(!station.panel.hasClass('panel-success'))
        {
          station.panel
            .removeClass('panel-default')
            .removeClass('panel-info')
            .addClass('panel-success');
        }
      }
      else
      {
        /* Station is streaming, but not selected */
        /* Blue panel - set if not already set */
        if(!station.panel.hasClass('panel-info'))
        {
          station.panel
            .removeClass('panel-default')
            .removeClass('panel-success')
            .addClass('panel-info');
        }
      }
    }
    else
    {
      /* Station is not streaming */
      /* Grey panel - set if not already set */
      if(!station.panel.hasClass('panel-default'))
      {
        station.panel
          .removeClass('panel-info')
          .removeClass('panel-success')
          .addClass('panel-default');
      }
    }
    
    /* Set panel title */
    $('#title-rx_station-'+station_id)
      .text(station.callsign);

    /* Set graph legend */
    if(station.callsign=="[Station Slot Free]")
    {
      $('#graph-legend-'+station_id)
        .text("");
    }
    else
    {
      $('#graph-legend-'+station_id)
        .text(station.callsign);
    }
    
    /* Set Labels */
    if(station.selected != 0)
    {
      $('#rx_station-selecting-label-'+station_id).fadeTo(50,1);
    }
    else
    {
      $('#rx_station-selecting-label-'+station_id).fadeTo(50,0.1);
    }
    if(station.received != 0)
    {
      $('#rx_station-streaming-label-'+station_id).fadeTo(50,1);
    }
    else
    {
      $('#rx_station-streaming-label-'+station_id).fadeTo(50,0.1);
    }
    if(station.lost_sum != 0)
    {
      $('#rx_station-netloss-label-'+station_id).fadeTo(50,1);
    }
    else
    {
      $('#rx_station-netloss-label-'+station_id).fadeTo(50,0.1);
    }

      
    /* Set text stats */
    $('#rx_station-total-'+station_id)
      .text(station.received_sum);
    $('#rx_station-selected-'+station_id)
      .text(station.selected_sum);
    $('#rx_station-netloss-'+station_id)
      .text(station.lost_sum);

    if(station.selected > 0)
    {
      rx_stations[station_id].graph_data.append(graphTime, station.selected_percent);
    }
    else
    {
      rx_stations[station_id].graph_data.append(graphTime, 0);
    }
  });
  
  setTimeout(render_stations,200);
}
create_stations();
render_stations();

function update_stations(stations)
{
  rx_stations.forEach(function(station,station_index)
  {
    rx_stations[station_index].connected = false;
  });

  stations.forEach(function(station,station_index)
  {
    rx_stations[station.id].connected = true;
    rx_stations[station.id].callsign = station.callsign;
    rx_stations[station.id].received = station.received;
    rx_stations[station.id].received_sum = station.received_sum;
    rx_stations[station.id].selected = station.selected;
    rx_stations[station.id].selected_percent = station.selected_percent;
    rx_stations[station.id].selected_sum = station.selected_sum;
    rx_stations[station.id].lost_sum = Math.max(0,station.lost_sum);
  });
}

var socket = io('https://hamtv.batc.tv', {
  path: "/tsmerge/socket.io",
});
socket.on('data', function (jdata)
{
  //console.log(jdata);
  var data;
  try
  {
    data = JSON.parse(jdata);
  }
  catch(e)
  {
    console.log("Error parsing JSON: "+jdata);
    return;
  }
  //console.log(data);
  mx_merger.data_received = new Date();
    
  switch(data.type)
  {
    case 'udprxbuffer':
      $("#rx_buffer_queue").text(data.queue);
      $("#rx_buffer_loss").text(data.loss);
      break;
      
    case 'merger':
      mx_merger.output_live = data.live;
      update_stations(data.stations);
      break;
      
    case 'threads':
        var threads_list = $("<ul></ul>");
        for(var i=0; i<data.threads.length; i++)
        {
            threads_list.append(
                $("<li></li>").text(
                    data.threads[i].name +
                    ": "+
                    data.threads[i].cpu_percent +
                    "%"
                )
            );
        }
        $("#server_threads").empty();
        $("#server_threads").append(threads_list);
        break;
      
    default:
      console.log("Unknown data type: "+data.type);
      break;
  }
});

function checkServer()
{
  if(mx_merger.data_received > (new Date() - 2000))
  {
    $("#tsmerge_server").text("Running");
  }
  else if(mx_merger.data_received > 0)
  {
    $("#tsmerge_server").text("Stopped");
  }
  setTimeout(checkServer, 100);
}
checkServer();

function dateStringFromEpoch(epoch)
{
  var date = new Date(epoch);
  return date.toDateString() + " " + date.toLocaleTimeString();
}
</script>
</html>
