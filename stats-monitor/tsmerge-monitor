#!/usr/bin/env node

const UDP_PORT_OPERATIONAL = 5680;
const UDP_PORT_TEST = 9980;

const WS_HOST = '127.0.0.1';
const WS_PORT = 3100;

const HTTP_HOST = '127.0.0.1';
const HTTP_PORT = 3101;

const dgram = require('dgram');

const http = require("http");
const SocketIo = require('socket.io');

let merger_data_operational = {};
let merger_data_test = {};

const WebSocketServer = new SocketIo.Server(WS_PORT, {
  path: "/hamtv/socket.io"
})

let ws_server_operational = WebSocketServer.of('/stats/operational').on("connection", socket => {
  console.log('New ws connection on /stats/operational');
  socket.join('operational');
});
let ws_server_test = WebSocketServer.of('/stats/test').on("connection", socket => {
  console.log('New ws connection on /stats/test');
});


const requestListener = function (req, res) {
    res.setHeader("Content-Type", "application/json");
    if(req.url.startsWith("/hamtv/merger/httpstats-operational"))
    {
      res.writeHead(200);
      res.end(JSON.stringify(merger_data_operational));
    }
    else if(req.url.startsWith("/hamtv/merger/httpstats-test"))
    {
      res.writeHead(200);
      res.end(JSON.stringify(merger_data_test));
    }
    else
    {
      res.writeHead(404);
      res.end(JSON.stringify({error:`Resource not found: ${req.url}`}));
    }
}

const httpserver = http.createServer(requestListener);
httpserver.listen(HTTP_PORT, HTTP_HOST, () => {
    console.log(`HTTP Server listening on http://${HTTP_HOST}:${HTTP_PORT}`);
});


console.log(`Setting up UDP servers..`);

// Operational

let server_operational = dgram.createSocket('udp4');

server_operational.on('message', function (message, remote) {
    const msg = message.toString();

    ws_server_operational.emit("msg", msg);

    const message_obj = JSON.parse(msg);
    if('type' in message_obj)
    {
      merger_data_operational[message_obj['type']] = message_obj;
      merger_data_operational['updated'] = Date.now();
    }
});

server_operational.bind(UDP_PORT_OPERATIONAL, '127.0.0.1');

// Test

let server_test = dgram.createSocket('udp4');

server_test.on('message', function (message, remote) {
    const msg = message.toString();

    ws_server_test.emit("msg", msg);

    const message_obj = JSON.parse(msg);
    if('type' in message_obj)
    {
      merger_data_test[message_obj['type']] = message_obj;
      merger_data_test['updated'] = Date.now();
    }
});

server_test.bind(UDP_PORT_TEST, '127.0.0.1');
